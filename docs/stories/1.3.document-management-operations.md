# Story 1.3: Document Management Operations

## Status
Draft

## Story
**As a** knowledge base user,  
**I want** to add and remove documents from the knowledge base,  
**so that** I can maintain an up-to-date and relevant information repository.

## Acceptance Criteria
1. Enhanced add document functionality preserves existing file type support (15+ formats) while adding metadata tracking
2. Document removal operations clean up both vector data and associated metadata completely
3. Batch document operations support multiple files while maintaining transaction safety
4. All operations integrate with existing Container DI system and RagAPI patterns

## Tasks / Subtasks
- [ ] Enhance existing add document functionality (AC: 1)
  - [ ] Extend RagAPI.add_document to capture enhanced metadata from Story 1.1
  - [ ] Update MCP add_document_from_file tool to return enhanced metadata information
  - [ ] Ensure all 15+ file types continue to work with enhanced metadata tracking
  - [ ] Preserve existing 800-character chunking strategy and processing pipeline
- [ ] Implement document removal operations (AC: 2)
  - [ ] Add remove_document method to RagAPI for single document removal
  - [ ] Create MCP tool remove_document_from_knowledge_base for document deletion
  - [ ] Implement complete cleanup of vector data and metadata in MilvusVectorDB
  - [ ] Add validation to prevent removal of non-existent documents
- [ ] Create batch document operations (AC: 3)
  - [ ] Add batch_add_documents method to RagAPI for multiple file processing
  - [ ] Add batch_remove_documents method to RagAPI for multiple document removal
  - [ ] Create MCP tools for batch operations with transaction safety
  - [ ] Implement progress tracking and error handling for batch operations
- [ ] Integration with existing systems (AC: 4)
  - [ ] Ensure all new methods integrate with Container DI pattern
  - [ ] Update VectorClient interface if needed for removal operations
  - [ ] Maintain compatibility with existing RagAPI method signatures
  - [ ] Update MCP server with new tools while preserving existing functionality
- [ ] Unit testing for document management (AC: 1-4)
  - [ ] Test enhanced add document functionality with metadata tracking
  - [ ] Test document removal operations and complete cleanup
  - [ ] Test batch operations with multiple files and error scenarios
  - [ ] Test integration with Container DI and existing patterns

## Dev Notes

### Previous Story Insights
From Story 1.1, the system now has enhanced Document model with 8 metadata fields (filename, file_type, ingestion_timestamp, chunk_count, file_size, chunk_position, vector_id, embedding_status) and enhanced MilvusVectorDB schema. The VectorClient.upload method was modified to capture file metadata during ingestion. Two new MCP tools were added for metadata access: get_document_metadata and list_documents_with_metadata.

### Data Models
**Enhanced Document Model** [Source: Story 1.1 Implementation]:
```python
@dataclass
class Document:
    content: str
    metadata: Dict[str, Any]
    id: Optional[str] = None
    # Enhanced metadata fields from Story 1.1
    filename: Optional[str] = None
    file_type: Optional[str] = None
    ingestion_timestamp: Optional[datetime] = None
    chunk_count: Optional[int] = None
    file_size: Optional[int] = None
    chunk_position: Optional[int] = None
    vector_id: Optional[str] = None
    embedding_status: str = "pending"
```

**Current RagAPI Methods** [Source: mcp_rag_playground/rag/rag_api.py:41-62]:
```python
def add_document(self, file_path: str) -> bool:
    """Add a document to the RAG system from a file."""
    # Current implementation only supports single file
    # Returns boolean success/failure
```

**Required New Methods**:
- `remove_document(self, document_id: str) -> bool` - Remove single document
- `batch_add_documents(self, file_paths: List[str]) -> Dict[str, Any]` - Batch add with results
- `batch_remove_documents(self, document_ids: List[str]) -> Dict[str, Any]` - Batch remove with results

### API Specifications
**Current MCP Tools** [Source: mcp_rag_playground/mcp/rag_server.py:89-100]:
```python
@mcp.tool()
def add_document_from_file(ctx: Context, file_path: str) -> Dict[str, Any]:
    """Add a document to the knowledge base from a file with intelligent processing."""
    # Current tool supports single file with path normalization
    # Returns success/error information
```

**Required New MCP Tools**:
- `remove_document_from_knowledge_base(document_id: str)` - Remove single document
- `batch_add_documents_from_files(file_paths: List[str])` - Batch add multiple files
- `batch_remove_documents_from_knowledge_base(document_ids: List[str])` - Batch remove multiple documents

**Current VectorDBInterface** [Source: mcp_rag_playground/vectordb/vector_db_interface.py]:
```python
class VectorDBInterface(ABC):
    @abstractmethod
    def insert_documents(self, collection_name: str, documents: List[Document], embeddings: List[List[float]]) -> bool
    # Note: No removal methods exist yet
```

**Required VectorDBInterface Extensions**:
- `remove_documents(self, collection_name: str, document_ids: List[str]) -> bool`
- `get_document_by_id(self, collection_name: str, document_id: str) -> Optional[Document]`

### Component Specifications
**Current Container DI Integration** [Source: docs/brownfield-architecture.md:130-132]:
The Container system instantiates RagAPI with VectorClient dependency injection. New document management operations must follow the same DI patterns without breaking existing service initialization.

**File Type Support** [Source: docs/brownfield-architecture.md:109-110]:
Current system supports 15+ file types through `vectordb/processor/file_processor.py`. Document management operations must preserve this extensive file type support including .txt, .md, .py, .json, .js, .ts, .css, .html, .yml, .yaml, .log files.

**Chunking Strategy** [Source: docs/brownfield-architecture.md:109]:
Current system uses 800-character chunking with 200-character overlap in `document_processor.py`. Enhanced document operations must maintain this existing strategy.

### File Locations
**Files to Modify**:
- `mcp_rag_playground/rag/rag_api.py` - Add document removal and batch operations methods
- `mcp_rag_playground/mcp/rag_server.py` - Add new MCP tools for document management
- `mcp_rag_playground/vectordb/milvus/milvus_client.py` - Implement document removal operations
- `mcp_rag_playground/vectordb/vector_db_interface.py` - Add removal methods to interface

**Test Files to Create/Modify**:
- `mcp_rag_playground/tests/test_document_management.py` - Document management operations tests
- `mcp_rag_playground/tests/test_rag_api.py` - Update existing RagAPI tests
- `mcp_rag_playground/tests/test_mcp_server.py` - Test new MCP tools

### Testing Requirements
**Current Test Structure** [Source: docs/brownfield-architecture.md:295-316]:
- Framework: pytest with markers system
- Coverage target: 80% minimum
- Markers: unit, integration, slow, milvus, embedding, performance, smoke
- Test files use `test_*.py` naming convention

**Test Requirements for This Story**:
- Unit tests for new RagAPI methods (marker: unit)
- Integration tests with real Milvus operations (marker: milvus, integration)
- MCP tools functionality tests with document operations
- Batch operations testing with multiple files and error scenarios
- Transaction safety testing for batch operations

### Technical Constraints
**Performance Requirements** [Source: docs/brownfield-prd.md:79-83]:
- Document operations must not exceed current memory usage by more than 20%
- Batch operations must be optimized to prevent system resource exhaustion
- Document removal must not degrade existing vector search performance

**Integration Verification Requirements** [Source: Epic Story 1.3]:
- IV1: Document additions maintain compatibility with existing 800-character chunking strategy
- IV2: Document removals properly clean up vector storage without affecting unrelated documents  
- IV3: Existing automated tests continue to pass with new document management capabilities

**Container DI Compliance** [Source: docs/brownfield-architecture.md:183]:
All new document management services must integrate with existing Container DI system following dependency inversion patterns.

### Architecture Integration
**SOLID Principles Compliance** [Source: docs/brownfield-architecture.md:170-183]:
- Single Responsibility: Document operations separated by concern (add/remove/batch)
- Open/Closed: New operations extend existing interfaces without modification
- Dependency Inversion: New methods depend on abstractions (VectorDBInterface)

**MCP Server Compatibility** [Source: docs/brownfield-architecture.md:132]:
Module-level FastMCP server with existing 4 tools must be extended with new document management tools while maintaining backward compatibility and path normalization for WSL.

### Testing
**Test File Location**: `mcp_rag_playground/tests/` following existing pattern

**Test Standards**:
- Use pytest framework with existing fixtures from `conftest.py`
- Follow existing marker system (unit, integration, milvus, etc.)
- Achieve 80% minimum code coverage
- Use real Milvus connection for integration tests
- Mock external dependencies for unit tests

**Testing Frameworks and Patterns**:
- Pytest with comprehensive markers system
- Real component integration tests (not just mocks)
- Coverage reporting with pytest-cov
- Fixtures organized by concern in `fixtures/` directory

**Specific Testing Requirements**:
- Enhanced metadata tracking: Verify document operations preserve metadata from Story 1.1
- Complete cleanup validation: Ensure document removal removes all vector data and metadata
- Batch operation safety: Test transaction rollback and partial failure scenarios  
- File type preservation: Verify all 15+ file types work with enhanced operations
- Performance validation: Ensure batch operations don't impact search performance

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-11 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*This section will be populated by the QA agent during review*