# Story 1.6: REST API Interface

## Status
Approved

## Story
**As a** web developer or external system integrator,  
**I want** REST API endpoints for question-answering and document operations,  
**so that** I can integrate the knowledge base with web applications and external systems via HTTP.

## Acceptance Criteria
1. **HTTP Endpoints**: Create REST API endpoints that wrap existing Q&A and document management functionality
2. **Response Consistency**: API responses match the format and quality of MCP tool responses
3. **Optional Deployment**: REST API can be enabled/disabled independently without affecting MCP functionality
4. **Web Integration**: Support CORS and standard HTTP patterns for web application integration

## Tasks / Subtasks
- [ ] Create REST API infrastructure (AC: 1, 3)
  - [ ] Create FastAPI application in `mcp_rag_playground/api/rest_server.py`
  - [ ] Implement API routing and endpoint organization
  - [ ] Add configuration support for enabling/disabling REST API
  - [ ] Set up CORS middleware for web application integration
- [ ] Implement Q&A API endpoints (AC: 1, 2)
  - [ ] Create POST /api/v1/ask endpoint wrapping QuestionAnsweringInterface from Story 1.5
  - [ ] Create GET /api/v1/search endpoint for backward compatibility with search functionality
  - [ ] Implement request validation and error handling for HTTP requests
  - [ ] Ensure response format consistency with MCP tool responses
- [ ] Implement document management API endpoints (AC: 1, 2)
  - [ ] Create POST /api/v1/documents endpoint for document upload
  - [ ] Create DELETE /api/v1/documents/{id} endpoint for document removal
  - [ ] Create GET /api/v1/documents endpoint for document listing with metadata
  - [ ] Support batch operations through appropriate HTTP patterns
- [ ] Add API documentation and configuration (AC: 4)
  - [ ] Generate OpenAPI/Swagger documentation for all endpoints
  - [ ] Add API versioning support for future extensibility
  - [ ] Implement rate limiting and basic security headers
  - [ ] Create configuration options for API deployment (port, host, SSL)
- [ ] Unit testing for REST API endpoints (AC: 1-4)
  - [ ] Test all API endpoints with various request types and payloads
  - [ ] Test response consistency with corresponding MCP tool responses
  - [ ] Test optional deployment and configuration options
  - [ ] Test CORS functionality and web integration patterns

## Dev Notes

### Previous Story Insights
This story depends on Story 1.5 (Enhanced Question-Answering Interface) being completed, as it wraps the QuestionAnsweringInterface functionality with HTTP endpoints. It also leverages document management operations from Stories 1.1-1.3 and enhanced metadata tracking for API responses.

### Data Models

**HTTP Request/Response Models** (New):
```python
# Request models for API endpoints
@dataclass
class QuestionRequest:
    question: str
    max_sources: int = 5
    include_context: bool = True

@dataclass
class DocumentUploadRequest:
    file_path: str
    enable_smart_processing: bool = True

# Response models matching MCP functionality
@dataclass
class APIResponse:
    success: bool
    data: Any
    message: str
    processing_time: float
```

**API Error Response Model**:
```python
@dataclass
class APIError:
    error: str
    code: int
    details: Optional[str] = None
    timestamp: str
```

### API Specifications

**REST Endpoints Design**:
```python
# Question-Answering Endpoints
POST /api/v1/ask
GET  /api/v1/search

# Document Management Endpoints  
POST   /api/v1/documents        # Upload document
GET    /api/v1/documents        # List documents with metadata
DELETE /api/v1/documents/{id}   # Remove document
POST   /api/v1/documents/batch  # Batch upload

# System Information
GET /api/v1/health              # Health check
GET /api/v1/docs                # API documentation
```

**FastAPI Integration Pattern**:
```python
from fastapi import FastAPI, HTTPException, UploadFile
from mcp_rag_playground.rag.qa_interface import QuestionAnsweringInterface
from mcp_rag_playground.rag.rag_api import RagAPI

app = FastAPI(title="RAG Knowledge Base API", version="1.0")

@app.post("/api/v1/ask")
async def ask_question(request: QuestionRequest) -> QAResponse:
    # Wrap existing Q&A functionality from Story 1.5
    qa_interface = container.question_answering_interface()
    return qa_interface.ask_question(request.question, request.max_sources)
```

### Component Specifications

**Optional Deployment Pattern**:
The REST API is an optional component that can be deployed alongside or separately from the MCP server. Configuration allows enabling/disabling the HTTP interface without affecting MCP functionality.

**Integration with Existing Services**:
- **Story 1.5 Dependency**: Wraps QuestionAnsweringInterface for /ask endpoint
- **Stories 1.1-1.3**: Uses document management operations for document endpoints
- **Container DI**: Leverages existing services through dependency injection
- **Consistent Responses**: HTTP responses match MCP tool response formats

**CORS and Web Integration**:
```python
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # Configurable for security
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

### File Locations

**Files to Create**:
- `mcp_rag_playground/api/rest_server.py` - FastAPI application and endpoints
- `mcp_rag_playground/api/__init__.py` - API package initialization
- `mcp_rag_playground/api/models.py` - HTTP request/response models
- `mcp_rag_playground/api/middleware.py` - CORS and security middleware
- `mcp_rag_playground/api/config.py` - API configuration settings

**Files to Modify**:
- `mcp_rag_playground/container/container.py` - Register REST API services (optional)
- `mcp_rag_playground/config/logging_config.py` - Add API logging configuration (optional)

**Test Files to Create**:
- `mcp_rag_playground/tests/test_rest_api.py` - REST API endpoint testing
- `mcp_rag_playground/tests/test_api_integration.py` - API integration tests
- `mcp_rag_playground/tests/fixtures/api_fixtures.py` - HTTP client fixtures

**Configuration Files**:
- `api_config.yaml` - API deployment configuration (optional)
- `docker-compose.api.yml` - Optional Docker deployment for API

### Testing Requirements

**Current Test Structure** [Source: docs/architecture/testing-reality.md]:
- Framework: pytest with markers system
- Coverage target: 80% minimum
- Test files use `test_*.py` naming convention
- HTTP testing with FastAPI TestClient

**Test Requirements for This Story**:
- Unit tests for API endpoints (marker: unit)
- Integration tests with real services (marker: integration, api)
- HTTP client tests using FastAPI TestClient
- CORS and middleware functionality tests
- API documentation and OpenAPI schema validation tests
- Response consistency tests comparing API vs. MCP responses

**API Testing Pattern**:
```python
from fastapi.testclient import TestClient
from mcp_rag_playground.api.rest_server import app

client = TestClient(app)

def test_ask_question_endpoint():
    response = client.post("/api/v1/ask", json={
        "question": "How do I configure the database?",
        "max_sources": 3
    })
    assert response.status_code == 200
    assert "answer" in response.json()
```

### Technical Constraints

**Performance Requirements**:
- API response times should be comparable to MCP tool response times
- HTTP overhead should not significantly impact query processing performance
- Support concurrent requests without resource contention with MCP server

**Security Considerations**:
- Basic security headers (CORS, content type validation)
- Rate limiting to prevent abuse
- Input validation and sanitization for all endpoints
- Optional authentication/authorization framework support

**Deployment Flexibility**:
- API can run on different port than MCP server
- Optional component that doesn't affect core MCP functionality
- Configurable CORS settings for different deployment environments
- Support for reverse proxy and load balancer deployment patterns

### Architecture Integration

**SOLID Principles Compliance**:
- Single Responsibility: REST API layer focuses solely on HTTP interface translation
- Open/Closed: Extends existing functionality without modifying core services
- Dependency Inversion: Depends on existing abstractions (QuestionAnsweringInterface, RagAPI)

**Existing Integration Points**:
- **Story 1.5**: Wraps QuestionAnsweringInterface for enhanced Q&A endpoints
- **RagAPI**: Uses existing document management operations for document endpoints
- **Container DI**: Leverages existing service configuration and dependency injection
- **Consistent Interface**: HTTP responses match MCP tool response formats for consistency

**Optional Deployment Architecture**:
```python
# Configuration-based API deployment
class APIConfig:
    enabled: bool = False
    host: str = "localhost"
    port: int = 8000
    cors_origins: List[str] = ["*"]
    rate_limit: int = 100  # requests per minute

# Conditional API startup
if api_config.enabled:
    uvicorn.run(app, host=api_config.host, port=api_config.port)
```

## Testing

**Test File Location**: `mcp_rag_playground/tests/` following existing pattern

**Test Standards**:
- Use pytest framework with FastAPI TestClient for HTTP testing
- Follow existing marker system, add 'api' marker for REST API tests
- Achieve 80% minimum code coverage for API components
- Test both successful and error scenarios for all endpoints

**Testing Frameworks and Patterns**:
- FastAPI TestClient for HTTP endpoint testing
- pytest-asyncio for async endpoint testing if needed
- Response validation against OpenAPI schema
- Integration tests with real backend services

**Specific Testing Requirements**:
- API endpoint functionality: Test all HTTP methods and response codes
- Response consistency: Compare API responses with corresponding MCP tool responses  
- CORS functionality: Test cross-origin requests and middleware behavior
- Error handling: Test API error responses and status codes
- Documentation: Validate OpenAPI/Swagger documentation generation
- Performance: Basic API response time and concurrency testing

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-15 | 1.0 | Initial REST API story creation, separated from Story 1.5 for focused implementation | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
*This section will be populated by the QA agent after story completion*