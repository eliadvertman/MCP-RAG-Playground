# Story 1.2: Schema Evolution Framework

## Status
Approved

## Story
**As a** system architect,  
**I want** a unified, evolvable vector database schema without legacy/non-legacy distinctions,  
**so that** the schema can adapt to new requirements without requiring code changes.

## Acceptance Criteria
1. Remove legacy/enhanced schema detection logic and use single unified schema approach
2. Make schema definitions configuration-driven instead of hardcoded in code
3. Schema changes require only configuration updates, not code modifications to core database operations
4. Manual collection recreation acceptable for schema changes (no automatic migration required)

## Tasks / Subtasks
- [ ] Remove legacy/enhanced schema detection logic (AC: 1)
  - [ ] Remove `_insert_documents_legacy()` method and logic
  - [ ] Remove `_parse_legacy_search_result()` method
  - [ ] Remove schema field count detection in insert_documents and search methods
  - [ ] Update all operations to use single unified (enhanced) schema approach
- [ ] Create configuration-driven schema definitions (AC: 2, 3)
  - [ ] Create schema configuration file defining field structures
  - [ ] Update MilvusConfig to include schema configuration settings
  - [ ] Modify create_collection to use configuration-driven schema instead of hardcoded fields
  - [ ] Ensure schema field changes only require config updates, not code modifications
- [ ] Unit testing for simplified schema framework (AC: 1-4)
  - [ ] Test removal of dual schema logic
  - [ ] Test configuration-driven schema creation
  - [ ] Test that schema changes work via configuration only
  - [ ] Test unified schema operations

## Dev Notes

### Previous Story Insights
From Story 1.1, the current system has problematic legacy/enhanced schema detection based on field count (4 vs 12 fields). This creates brittle code that breaks when field counts change and requires code modifications for schema evolution. The enhanced schema includes individual metadata fields for efficient querying, but the dual-schema approach creates complexity and maintenance overhead.

### Data Models
**Current Schema Detection Pattern** [Source: mcp_rag_playground/vectordb/milvus/milvus_client.py:101-113]:
```python
# Problematic field count detection
schema_fields = [field.name for field in collection.schema.fields]
is_enhanced_schema = len(schema_fields) > 4  # Brittle logic

if is_enhanced_schema:
    return self._insert_documents_enhanced(collection, documents, embeddings)
else:
    return self._insert_documents_legacy(collection, documents, embeddings)
```

**Current Enhanced Schema Fields** [Source: mcp_rag_playground/vectordb/milvus/milvus_client.py:47-61]:
```python
fields = [
    FieldSchema(name="id", dtype=DataType.VARCHAR, max_length=65535, is_primary=True),
    FieldSchema(name="content", dtype=DataType.VARCHAR, max_length=65535),
    FieldSchema(name="metadata", dtype=DataType.VARCHAR, max_length=65535),
    # Enhanced metadata fields
    FieldSchema(name="filename", dtype=DataType.VARCHAR, max_length=1024),
    FieldSchema(name="file_type", dtype=DataType.VARCHAR, max_length=50),
    FieldSchema(name="ingestion_timestamp", dtype=DataType.VARCHAR, max_length=100),
    FieldSchema(name="chunk_count", dtype=DataType.INT32),
    FieldSchema(name="file_size", dtype=DataType.INT64),
    FieldSchema(name="chunk_position", dtype=DataType.INT32),
    FieldSchema(name="vector_id", dtype=DataType.VARCHAR, max_length=100),
    FieldSchema(name="embedding_status", dtype=DataType.VARCHAR, max_length=50),
    FieldSchema(name="embedding", dtype=DataType.FLOAT_VECTOR, dim=dimension)
]
```

**Required Schema Configuration System**:
- Configuration file defining schema fields instead of hardcoded field lists
- MilvusConfig extension to include schema settings
- No complex version management or migration utilities needed
- Manual collection recreation acceptable for schema changes

### API Specifications
**Current MilvusVectorDB Interface** [Source: mcp_rag_playground/vectordb/vector_db_interface.py:25-40]:
```python
class VectorDBInterface(ABC):
    @abstractmethod
    def create_collection(self, collection_name: str, dimension: int) -> bool
    @abstractmethod
    def insert_documents(self, collection_name: str, documents: List[Document], embeddings: List[List[float]]) -> bool
    @abstractmethod
    def search(self, collection_name: str, query_embedding: List[float], top_k: int = 10, min_score: float = 0.0) -> List[SearchResult]
```

**No Additional Interface Methods Required**:
- Existing VectorDBInterface methods remain unchanged
- No migration methods needed (manual collection recreation acceptable)
- Schema changes handled through configuration, not code

### Component Specifications
**Current Container DI Integration** [Source: docs/brownfield-architecture.md:130-132]:
The Container system instantiates MilvusVectorDB with config. Schema evolution must integrate through the same DI pattern without breaking existing service initialization.

**Schema Configuration Management**:
- Schema fields defined in configuration files, not hardcoded in code
- MilvusConfig extended to include schema field definitions
- No additional services needed in Container

### File Locations
**Files to Modify**:
- `mcp_rag_playground/vectordb/milvus/milvus_client.py` - Remove dual schema logic, use configuration-driven approach
- `mcp_rag_playground/config/milvus_config.py` - Add schema field configuration

**Files to Create**:
- `mcp_rag_playground/config/schema_config.py` - Schema field definitions configuration

**Test Files to Create/Modify**:
- `mcp_rag_playground/tests/test_schema_config.py` - Schema configuration tests

### Testing Requirements
**Current Test Structure** [Source: docs/brownfield-architecture.md:295-316]:
- Framework: pytest with markers system
- Coverage target: 80% minimum  
- Markers: unit, integration, slow, milvus, embedding, performance, smoke
- Test files use `test_*.py` naming convention

**Test Requirements for This Story**:
- Unit tests for schema configuration management (marker: unit)
- Integration tests with real Milvus collections using unified schema (marker: milvus, integration)
- Tests ensuring dual schema detection logic is completely removed
- Tests verifying configuration-driven schema creation works correctly

### Technical Constraints
**Performance Requirements** [Source: docs/brownfield-prd.md:79-83]:
- Schema operations must not exceed current memory usage by more than 20%
- Removing dual schema logic should improve performance by eliminating field count detection
- Configuration loading must be optimized for frequent collection creation

**System Reality and Constraints**:
- **Manual Migration Required**: Schema changes require manual collection deletion and recreation
- **Data Loss Acceptable**: No backward compatibility or data preservation features
- Current VectorDBInterface methods must maintain existing signatures
- Configuration-driven approach replaces hardcoded schema definitions

### Architecture Integration
**SOLID Principles Compliance** [Source: docs/brownfield-architecture.md:170-179]:
- Single Responsibility: Schema management separated from database operations
- Open/Closed: Configuration-driven schema allows extension without modification
- Dependency Inversion: Abstract interfaces enable different migration strategies

**Container DI Integration** [Source: docs/brownfield-architecture.md:260-265]:
Schema configuration must integrate with existing Container DI system without breaking current service instantiation patterns. No additional services required.

### Testing
**Test File Location**: `mcp_rag_playground/tests/` following existing pattern

**Test Standards**:
- Use pytest framework with existing fixtures from `conftest.py`
- Follow existing marker system (unit, integration, milvus, etc.)
- Achieve 80% minimum code coverage
- Use real Milvus connection for integration tests
- Mock external dependencies for unit tests

**Testing Frameworks and Patterns**:
- Pytest with comprehensive markers system
- Real component integration tests (not just mocks)  
- Coverage reporting with pytest-cov
- Fixtures organized by concern in `fixtures/` directory

**Specific Testing Requirements**:
- Dual schema removal: Verify all legacy detection logic is completely removed
- Configuration validation: Test schema config parsing and field generation
- Unified schema operation: Verify all operations use single schema approach
- Performance validation: Ensure removing dual logic improves performance

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-11 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*This section will be populated by the QA agent during review*